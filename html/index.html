<!DOCTYPE html>
<html lang="ja">
<htad>
  <meta charset="utf-8">
  <title>HTTPD log database</title>
  <style>
<!--
  .click { text-decoration: underline; }
-->
  </style>
  <script>
<!--
const api_site = 'api/site.cgi';
const api_get = 'api/get.cgi';
const api_ana = 'api/ana.cgi';
let site_list = [];
let site_tz = '';
let last_res;
function get_data(api, query, callback) {
  document.getElementById('sres_fetch').style.display = 'block';
  document.getElementById('sres_fetch_fin').style.display = 'none';
  document.getElementById('sres_fetch_err').style.display = 'none';
  fetch(api + '?' + query)
  .then((res) => {
    if (res.ok) { return res.json(); }
    else { throw Error('failed to fetch data'); }
  }).then((res) => {
    document.getElementById('sres_fetch_fin').style.display = 'inline';
    last_res = res;
    callback(res);
  }).catch((e) => {
    document.getElementById('sres_fetch_err').style.display = 'inline';
  });
}
function dcURI(s) {
  let r = s;
  try {
    let tmp = decodeURI(s);
    r = tmp;
  } catch(e) { // do nothing
  }
  return r;
}
function show_access(res) {
  let ch = '';
  Object.keys(res['count']).sort((a,b) => {return res['count'][b] - res['count'][a]; }).forEach((item) => {
    ch += '<li>' + res['count'][item] + ': <tt>' + dcURI(item) + '</tt></li>';
  })
  document.getElementById('searchres').innerHTML = ch;
}
function show_page(res) {
  let ch = '';
  Object.keys(res['count']).sort().reverse().forEach((item) => {
    ch += '<li><tt>' + item + '</tt>: ' + res['count'][item] + '</li>';
  })
  document.getElementById('searchres').innerHTML = ch;
}
function show_list(res) {
  let ch = '';
  Object.keys(res['count']).sort((a,b) => {return res['count'][b] - res['count'][a]; }).forEach((item) => {
    ch += '<li>' + res['count'][item] + ': <tt>' + item + '</tt></li>';
  })
  document.getElementById('searchres').innerHTML = ch;
}
function show_ana_list(res) {
  let ch = '';
  if (document.getElementById('sres_sns_page_chk').checked) {
    let reconst = {};
    Object.keys(res['count']).forEach((item) => {
      if (res['count'][item]['page'] in reconst) {
        reconst[res['count'][item]['page']]['count'] += res['count'][item]['sum'];
      } else {
        reconst[res['count'][item]['page']] = { 'count': res['count'][item]['sum'], 'items': {} };
      }
      reconst[res['count'][item]['page']]['items'][item] = res['count'][item]['sum'];
    });
    let culid = 0;
    Object.keys(reconst).sort((a,b) => {return reconst[b]['count'] - reconst[a]['count']; }).forEach((page) => {
      ch += '<li>' + reconst[page]['count'] + ': <tt>' + dcURI(page) + '</tt> <a onclick="document.getElementById(\'sres_closeul_' + culid + '\').style.display = \'block\';">(open list)</a><ul id="sres_closeul_' + culid + '" style="display:none;">';
      Object.keys(reconst[page]['items']).sort((a,b) => {return reconst[page]['items'][b] - reconst[page]['items'][a]; }).forEach((item) => {
        ch += '<li>' + reconst[page]['items'][item] + ': <tt>' + item + '</tt></li>';
      })
      ch += '</ul></li>';
      culid++;
    })
  } else {
    Object.keys(res['count']).sort((a,b) => {return res['count'][b]['sum'] - res['count'][a]['sum']; }).forEach((item) => {
      ch += '<li>' + res['count'][item]['sum'] + ': <tt>' + dcURI(res['count'][item]['page']) + ' (' + item + ')</tt></li>';
    })
  }
  document.getElementById('searchres').innerHTML = ch;
}
function show_ana_page(res) {
  let ch = '';
  Object.keys(res['count']).sort((a,b) => {return res['count'][b]['sum'] - res['count'][a]['sum']; }).forEach((item) => {
    ch += '<li>' + res['count'][item]['sum'] + ': <tt>' + item + '</tt></li>';
  })
  document.getElementById('searchres').innerHTML = ch;
}
function show_graph() {
  if (!document.getElementById('sres_graph_chk').checked) {
    document.getElementById('sres_graph_svg').style.display = 'none';
    return;
  }
  document.getElementById('sres_graph_svg').style.display = 'block';
  let dts = Object.keys(last_res['count']).sort().reverse();
  let maxcnt = 0;
  dts.forEach((dt) => { if (parseInt(last_res['count'][dt]) > maxcnt) { maxcnt = parseInt(last_res['count'][dt]); } });
  document.getElementById('sres_graph_svg_max').textContent = maxcnt;
  document.getElementById('sres_graph_svg_min').textContent = '0';
  document.getElementById('sres_graph_svg_start').textContent = dts[dts.length - 1];
  document.getElementById('sres_graph_svg_end').textContent = dts[0];
  const dst = new Date(dts[dts.length - 1]);
  let dtmp = new Date(dts[0]);
  const dw = (dtmp - dst) / 86400000;
  const bbtm = 225;
  const bhgt = 220;
  const bst = document.getElementById('sres_graph_svg').clientWidth / 90 * 5;
  const bwd = document.getElementById('sres_graph_svg').clientWidth / 90 * 80;

  let pts = '';
  dts.forEach((dt) => {
    dtmp = new Date(dt);
    let curx = (dtmp - dst) / 86400000 / dw * bwd + bst;
    let cury = bbtm - (last_res['count'][dt] / maxcnt * bhgt);
    pts += curx + ',' + cury + ' ';
  })
  document.getElementById('sres_graph_svg_pl1').setAttribute('points', pts);
}
function exec_query() {
  let sel = document.getElementById('target_set').elements['condition'].value;
  let site = document.getElementById('target_site').value;
  let param = '';
  let use_date = 0, use_page = 0;
  if (document.getElementById('cond_date').checked) {
    document.getElementById('sres_date_sted').style.display = 'inline';
    document.getElementById('sres_date_none').style.display = 'none';
    document.getElementById('sres_date_st').innerText = document.getElementById('cond_date_st').value;
    document.getElementById('sres_date_ed').innerText = document.getElementById('cond_date_ed').value;
    param += '&dst=' + document.getElementById('cond_date_st').value + '&ded=' + document.getElementById('cond_date_ed').value;
    use_date = 1;
  } else {
    document.getElementById('sres_date_sted').style.display = 'none';
    document.getElementById('sres_date_none').style.display = 'inline';
    document.getElementById('sres_date_st').innerText = '';
    document.getElementById('sres_date_ed').innerText = '';
  }
  if (document.getElementById('cond_page').checked) {
    document.getElementById('sres_page').style.display = 'inline';
    document.getElementById('sres_page_none').style.display = 'none';
    document.getElementById('sres_page').innerText = document.getElementById('cond_page_name').value;
    param += '&page=' + document.getElementById('cond_page_name').value;
    use_page = 1;
  } else {
    document.getElementById('sres_page').style.display = 'none';
    document.getElementById('sres_page_none').style.display = 'inline';
    document.getElementById('sres_page').innerText = '';
  }
  document.getElementById('sres_site').innerText = site;
  document.getElementById('sres_sns_page').style.display = 'none';
  document.getElementById('sres_graph').style.display = 'none';

  if ((use_date + use_page == 0) && (sel.substr(0, 4) != 'sns_')) { return; }
  if (sel == 'access') {
    if (use_page != 0) {
      get_data(api_get, 'site=' + site + '&target=page' + param, show_page);
      document.getElementById('sres_graph').style.display = 'block';
      document.getElementById('sres_graph_chk').checked = false;
      document.getElementById('sres_graph_svg').style.display = 'none';
    } else { get_data(api_get, 'site=' + site + '&target=page' + param, show_access); }
  } else if (sel == 'ref') {
    get_data(api_get, 'site=' + site + '&target=ref' + param, show_access);
  } else if (sel == 'ua') {
    get_data(api_get, 'site=' + site + '&target=ua' + param, show_list);
  } else if (sel == 'sns_fb') {
    if (use_page == 0) {
      get_data(api_ana, 'site=' + site + '&target=sns_fb' + param, show_ana_list);
      document.getElementById('sres_sns_page').style.display = 'block';
    } else { get_data(api_ana, 'site=' + site + '&target=sns_fb' + param, show_ana_page); }
  } else if (sel == 'sns_x') {
    if (use_page == 0) {
      get_data(api_ana, 'site=' + site + '&target=sns_x' + param, show_ana_list);
      document.getElementById('sres_sns_page').style.display = 'block';
    } else { get_data(api_ana, 'site=' + site + '&target=sns_x' + param, show_ana_page); }
  }
}
function check_sted(tgt, put) {
  let check;
  let orig;
  if (put == 'st') { check = tgt + '_ed'; orig = tgt + '_st'; }
  else { check = tgt + '_st'; orig = tgt + '_ed'; }
  if (document.getElementById(check).value == '') { document.getElementById(check).value = document.getElementById(orig).value; }
}
window.addEventListener('load', () => {
  document.getElementById('cond_exec').addEventListener('click', exec_query);
  document.getElementById('cond_date_st').addEventListener('change', () => { check_sted('cond_date', 'st'); });
  document.getElementById('cond_date_ed').addEventListener('change', () => { check_sted('cond_date', 'ed'); });
  document.getElementById('cond_date').addEventListener('change', (e) => {
    document.getElementById('cond_date_st').disabled = !e.target.checked;
    document.getElementById('cond_date_ed').disabled = !e.target.checked;
  });
  document.getElementById('cond_page').addEventListener('change', (e) => {
    document.getElementById('cond_page_name').disabled = !e.target.checked;
  });
  document.getElementById('sres_sns_page_chk').addEventListener('change', () => { show_ana_list(last_res); });
  document.getElementById('sres_graph_chk').addEventListener('change', () => { show_graph(); });
  fetch(api_site)
  .then((res) => {
    if (res.ok) { return res.json(); }
    else { throw Error('failed to fetch site list'); }
  }).then((res) => {
    site_tz = res['log_tz'];
    document.getElementById('logtz').innerText = site_tz;
    site_list = res['sites'].sort();
    let elem = document.getElementById('target_site');
    site_list.forEach((item) => {
      let ch = '<option value="' + item + '">' + item + '</option>';
      elem.innerHTML += ch;
    });
  }).catch((e) => {
    // anything?
  })
})
-->
  </script>
</head>
<body>
<div id="showlog">
<h1>ウェブサーバログ解析結果表示</h1>
<p>
  このページでは、このサーバに載っているウェブサーバのアクセス解析を提供しています。
  以下の日付選択は<tt><span id="logtz"></span></tt>での0時から24時までのアクセス数を表示します。
  <br>
  サイトごとの解析結果表示へのアクセス制限は未実装です。
  <br>
  以下の固定パラメータ以外の動的解析は未実装です。
</p>
<h2>パラメータ設定</h2>
<div>
  <form id="target_set">
  <label for="target_site">ターゲットサイト:</label>
  <select id="target_site"></select>
  <fieldset>
    <legend>詳細検索設定</legend>
    <ul>
      <li>
        <input type="checkbox" id="cond_date"><label for="cond_date">解析対象期間設定を行う (チェックを外した場合はログが存在する全期間が対象となります)</label>:
        <input type="text" id="cond_date_st" placeholder="YYYY-MM-DD" inputmode="decimal" disabled> ～
        <input type="text" id="cond_date_ed" placeholder="YYYY-MM-DD" inputmode="decimal" disabled> ("年-月-日"の形式です)
      </li>
      <li>
        <input type="checkbox" id="cond_page"><label for="cond_page">解析対象ページ設定を行う (チェックを外した場合は全ページが対象となります)</label>:
        <input type="text" id="cond_page_name" placeholder="/" size="50" disabled>
      </li>
      <li>解析内容選択<ul>
        <li>
          <input type="radio" name="condition" id="cond_ana_access" value="access" checked><label for="cond_ana_access">アクセス数解析</label>
          (期間とページの両方を指定した場合は、指定期間中の日ごとのアクセス数を表示します; 対象ページを指定した場合のみ日ごとのグラフ表示機能が有効になります)
        </li>
        <li>
          <input type="radio" name="condition" id="cond_ana_ref" value="ref"><label for="cond_ana_ref">リンク元解析</label>
          (アクセス元にはサイト内でのページ遷移も含み、画像などのリソースが解析対象に含まれる場合はリソースを読み込むページも含まれます)
        </li>
        <li><input type="radio" name="condition" id="cond_ana_ua" value="ua"><label for="cond_ana_ua">ブラウザ解析</label></li>
        <li>SNSからの流入解析 (生ログを解析するため結果表示に時間がかかる場合があります。また、流入元ポストの特定は各SNSサービスとの連携が必要となるためこのシステムでは対象外です)<ul>
          <li>
            <input type="radio" name="condition" id="cond_sns_fb" value="sns_fb"><label for="cond_sns_fb">Facebook</label>
            (fbclidがついたアクセスを集計します)
          </li>
          <li>
            <input type="radio" name="condition" id="cond_sns_x" value="sns_x"><label for="cond_sns_x">X (Twitter)</label>
            (t.co経由のアクセスを集計します)
          </li>
        </ul></li>
      </ul></li>
    </ul>
  </fieldset>
  <input type="button" value="表示" id="cond_exec">
  </form>
</div>
<h2>検索結果</h2>
<ul>
  <li>ターゲットサイト: <span id="sres_site"></span></li>
  <li>期間指定: <span id="sres_date_sted" style="display: none;"><span id="sres_date_st"></span> 〜 <span id="sres_date_ed"></span></span><span id="sres_date_none">期間未指定</span></li>
  <li>ページ指定: <span id="sres_page" style="display: none;"></span><span id="sres_page_none">ページ未指定</span></li>
</ul>
<h3>結果リスト</h3>
<p id="sres_fetch" style="display: none">
  サーバからデータの取得中です
  <span id="sres_fetch_fin" style="display: none"> ... 完了しました</span>
  <span id="sres_fetch_err" style="display: none"> ... サーバからのデータ取得でエラーが発生しました</span>
</p>
<p>
  表示ボタンを押しても以下に何も表示されないもしくは更新されない場合は検索設定に誤りがある可能性があります。
</p>
<p id="sres_sns_page" style="display: none;">
  <input type="checkbox" id="sres_sns_page_chk"><label for="sres_sns_page_chk">ターゲットとなったページごとにまとめて表示する</label>
</p>
<p id="sres_graph" style="display: none;">
  <input type="checkbox" id="sres_graph_chk"><label for="sres_graph_chk">グラフ表示</label>
  <svg id="sres_graph_svg" width="90vw" height="250px" style="display: none; margin: 1em 5vw;">
    <rect y="5px" width="80vw" height="220px" fill="none" stroke="black" strokewidth="2px" x="5vw"></rect>
    <text x="4.5vw" y="15px" text-anchor="end" id="sres_graph_svg_max"></text>
    <text x="4.5vw" y="225px" text-anchor="end" id="sres_graph_svg_min"></text>
    <text x="5vw" y="245px" text-anchor="middle" id="sres_graph_svg_start"></text>
    <text x="85vw" y="245px" text-anchor="middle" id="sres_graph_svg_end"></text>
    <g id="sres_graph_svg_graphs">
      <polyline points="" fill="none" stroke="black" id="sres_graph_svg_pl1"></polyline>
    </g>
  </svg>
</p>
<ul id="searchres"></ul>
</body>
</html>