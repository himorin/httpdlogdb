<!DOCTYPE html>
<html lang="ja">
<htad>
  <meta charset="utf-8">
  <title>HTTPD log database</title>
  <style>
<!--
  .click { text-decoration: underline; }
-->
  </style>
  <script>
<!--
const api_site = 'api/site.cgi';
const api_get = 'api/get.cgi';
const api_ana = 'api/ana.cgi';
let site_list = [];
let site_tz = '';
function get_data(api, query, callback) {
  fetch(api + '?' + query)
  .then((res) => {
    if (res.ok) { return res.json(); }
    else { throw Error('failed to fetch data'); }
  }).then((res) => {
    callback(res);
  }).catch((e) => {
    // anything?
  });
}
function show_access(res) {
  let ch = '';
  Object.keys(res['count']).sort((a,b) => {return res['count'][b] - res['count'][a]; }).forEach((item) => {
    ch += '<li>' + res['count'][item] + ': <tt>' + item + '</tt></li>';
  })
  document.getElementById('searchres').innerHTML = ch;
}

function show_page_date(res) {
  let ch = '';
  Object.keys(res['count']).sort((a,b) => {return res['count'][b] - res['count'][a]; }).forEach((item) => {
    ch += '<li>' + res['count'][item] + ': <tt class="click" onclick="show_pagename_name(\'' + item + '\')">' + item + '</tt></li>';
  })
  document.getElementById('searchres').innerHTML = ch;
}
function show_page_page(res) {
  let ch = '';
  Object.keys(res['count']).sort().reverse().forEach((item) => {
    ch += '<li><span class="click" onclick="show_pageday_date(\'' + item + '\')">' + item + '</span>: ' + res['count'][item] + '</li>';
  })
  document.getElementById('searchres').innerHTML = ch;
}
function show_pageday_date(date) {
  get_data('site=' + document.getElementById('target_site').value + '&target=page&date=' + date, show_page_date);
  document.getElementById('cond_pageday').checked = true;
  document.getElementById('cond_pageday_date').value = date;
}
function show_pagename_name(name) {
  get_data('site=' + document.getElementById('target_site').value + '&target=page&page=' + name, show_page_page);
  document.getElementById('cond_pagename').checked = true;
  document.getElementById('cond_pagename_name').value = name;
}

function show_ana_list(res) {
  let ch = '';
  Object.keys(res['count']).sort((a,b) => {return res['count'][b]['sum'] - res['count'][a]['sum']; }).forEach((item) => {
    ch += '<li>' + res['count'][item]['sum'] + ': <tt>' + res['count'][item]['page'] + ' (' + item + ')</tt></li>';
  })
  document.getElementById('searchres').innerHTML = ch;
}
function show_ana_list(res) {
  let ch = '';
  Object.keys(res['count']).sort((a,b) => {return res['count'][b]['sum'] - res['count'][a]['sum']; }).forEach((item) => {
    ch += '<li>' + res['count'][item]['sum'] + ': <tt>' + item + '</tt></li>';
  })
  document.getElementById('searchres').innerHTML = ch;
}
function show_list(res) {
  let ch = '';
  Object.keys(res['count']).sort((a,b) => {return res['count'][b] - res['count'][a]; }).forEach((item) => {
    ch += '<li>' + res['count'][item] + ': <tt>' + item + '</tt></li>';
  })
  document.getElementById('searchres').innerHTML = ch;
}
function exec_query() {
  let sel = document.getElementById('target_set').elements['condition'].value;
  let site = document.getElementById('target_site').value;
  let param = '';
  let use_date = 0, use_page = 0;
  if (document.getElementById('cond_date').checked) {
    document.getElementById('sres_date_sted').style.display = 'inline';
    document.getElementById('sres_date_none').style.display = 'none';
    document.getElementById('sres_date_st').innerText = document.getElementById('cond_date_st').value;
    document.getElementById('sres_date_ed').innerText = document.getElementById('cond_date_ed').value;
    param += '&dst=' + document.getElementById('cond_date_st').value + '&ded=' + document.getElementById('cond_date_ed').value;
    use_date = 1;
  } else {
    document.getElementById('sres_date_sted').style.display = 'none';
    document.getElementById('sres_date_none').style.display = 'inline';
    document.getElementById('sres_date_st').innerText = '';
    document.getElementById('sres_date_ed').innerText = '';
  }
  if (document.getElementById('cond_page').checked) {
    document.getElementById('sres_page').style.display = 'inline';
    document.getElementById('sres_page_none').style.display = 'none';
    document.getElementById('sres_page').innerText = document.getElementById('cond_page_name').value;
    param += '&page=' + document.getElementById('cond_page_name').value;
    use_page = 1;
  } else {
    document.getElementById('sres_page').style.display = 'none';
    document.getElementById('sres_page_none').style.display = 'inline';
    document.getElementById('sres_page').innerText = '';
  }

  if (use_date + use_page == 0) { return; }
  if (sel == 'access') {
    if (use_page != 0) { get_data(api_get, 'site=' + site + '&target=page' + param, show_access); }
    else { get_data(api_get, 'site=' + site + '&target=page' + param, show_list); }
  } else if (sel == 'ref') {
    get_data(api_get, 'site=' + site + '&target=ref' + param, show_list);
  } else if (sel == 'ua') {
    get_data(api_get, 'site=' + site + '&target=ua' + param, show_list);
  } else if (sel == 'sns_fb') {
    if (use_page == 0) { get_data(api_ana, 'site=' + site + '&target=sns_fb' + param, show_ana_list); }
    else { get_data(api_ana, 'site=' + site + '&target=sns_fb' + param, show_ana_page); }
  } else if (sel == 'sns_x') {
    get_data(api_ana, 'site=' + site + '&target=sns_x' + param, show_list);
  }
}
function check_sted(tgt, put) {
  let check;
  let orig;
  if (put == 'st') { check = tgt + '_ed'; orig = tgt + '_st'; }
  else { check = tgt + '_st'; orig = tgt + '_ed'; }
  if (document.getElementById(check).value == '') { document.getElementById(check).value = document.getElementById(orig).value; }
}
window.addEventListener('load', () => {
  document.getElementById('cond_exec').addEventListener('click', exec_query);
  document.getElementById('cond_date_st').addEventListener('change', () => { check_sted('cond_date', 'st'); });
  document.getElementById('cond_date_ed').addEventListener('change', () => { check_sted('cond_date', 'ed'); });
  document.getElementById('cond_date').addEventListener('change', (e) => {
    document.getElementById('cond_date_st').disabled = !e.target.checked;
    document.getElementById('cond_date_ed').disabled = !e.target.checked;
  });
  document.getElementById('cond_page').addEventListener('change', (e) => {
    document.getElementById('cond_page_name').disabled = !e.target.checked;
  });
  fetch(api_site)
  .then((res) => {
    if (res.ok) { return res.json(); }
    else { throw Error('failed to fetch site list'); }
  }).then((res) => {
    site_tz = res['log_tz'];
    document.getElementById('logtz').innerText = site_tz;
    site_list = res['sites'].sort();
    let elem = document.getElementById('target_site');
    site_list.forEach((item) => {
      let ch = '<option value="' + item + '">' + item + '</option>';
      elem.innerHTML += ch;
    });
  }).catch((e) => {
    // anything?
  })
})
-->
  </script>
</head>
<body>
<div id="showlog">
<h1>ウェブサーバログ解析結果表示</h1>
<p>
  このページでは、このサーバに載っているウェブサーバのアクセス解析を提供しています。
  以下の日付選択は<tt><span id="logtz"></span></tt>での0時から24時までのアクセス数を表示します。
  <br>
  サイトごとの解析結果表示へのアクセス制限は未実装です。
  <br>
  以下の固定パラメータ以外の動的解析は未実装です。
</p>
<h2>パラメータ設定</h2>
<div>
  <form id="target_set">
  <label for="target_site">ターゲットサイト:</label>
  <select id="target_site"></select>
  <fieldset>
    <legend>詳細検索設定</legend>
    <ul>
      <li>
        <input type="checkbox" id="cond_date"><label for="cond_date">解析対象期間設定を行う (チェックを外した場合はログが存在する全期間が対象となります)</label>:
        <input type="text" id="cond_date_st" placeholder="YYYY-MM-DD" inputmode="decimal" disabled> ～
        <input type="text" id="cond_date_ed" placeholder="YYYY-MM-DD" inputmode="decimal" disabled> ("年-月-日"の形式です)
      </li>
      <li>
        <input type="checkbox" id="cond_page"><label for="cond_page">解析対象ページ設定を行う (チェックを外した場合は全ページが対象となります)</label>:
        <input type="text" id="cond_page_name" placeholder="/" size="50" disabled>
      </li>
      <li>解析内容選択<ul>
        <li>
          <input type="radio" name="condition" id="cond_ana_access" value="access" checked><label for="cond_ana_access">アクセス数解析</label>
          (期間とページの両方を指定した場合は、指定期間中の日ごとのアクセス数を表示します)
        </li>
        <li>
          <input type="radio" name="condition" id="cond_ana_ref" value="ref"><label for="cond_ana_ref">リンク元解析</label>
          (アクセス元にはサイト内でのページ遷移も含み、画像などのリソースが解析対象に含まれる場合はリソースを読み込むページも含まれます)
        </li>
        <li><input type="radio" name="condition" id="cond_ana_ua" value="ua"><label for="cond_ana_ua">ブラウザ解析</label></li>
        <li>SNSからの流入解析 (生ログを解析するため結果表示に時間がかかる場合があります。また、流入元ポストの特定は各SNSサービスとの連携が必要となるためこのシステムでは対象外です)<ul>
          <li>
            <input type="radio" name="condition" id="cond_sns_fb" value="sns_fb"><label for="cond_sns_fb">Facebook</label>
            (fbclidがついたアクセスを集計します)
          </li>
          <li>
            <input type="radio" name="condition" id="cond_sns_x" value="sns_x"><label for="cond_sns_x">X (Twitter)</label>
            (t.co経由のアクセスを集計します)
          </li>
        </ul></li>
      </ul></li>
    </ul>
  </fieldset>
  <input type="button" value="表示" id="cond_exec">
  </form>
</div>
<h2>検索結果</h2>
<ul>
  <li>ターゲットサイト: <span id="sres_site"></span></li>
  <li>期間指定: <span id="sres_date_sted" style="display: none;"><span id="sres_date_st"></span> 〜 <span id="sres_date_ed"></span></span><span id="sres_date_none">期間未指定</span></li>
  <li>ページ指定: <span id="sres_page" style="display: none;"></span><span id="sres_page_none">ページ未指定</span></li>
</ul>
<h3>結果リスト</h3>
<p>
  表示ボタンを押しても以下に何も表示されないもしくは更新されない場合は検索設定に誤りがある可能性があります。
</p>
<ul id="searchres"></ul>
</body>
</html>