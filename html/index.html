<!DOCTYPE html>
<html lang="ja">
<htad>
  <meta charset="utf-8">
  <title>HTTPD log database</title>
  <style>
<!--
  .click { text-decoration: underline; }
-->
  </style>
  <script>
<!--
const api_site = 'api/site.cgi';
const api_get = 'api/get.cgi';
let site_list = [];
let site_tz = '';
function get_data(query, callback) {
  fetch(api_get + '?' + query)
  .then((res) => {
    if (res.ok) { return res.json(); }
    else { throw Error('failed to fetch data'); }
  }).then((res) => {
    callback(res);
  }).catch((e) => {
    // anything?
  });
}
function show_page_date(res) {
  let ch = '';
  Object.keys(res['count']).sort((a,b) => {return res['count'][b] - res['count'][a]; }).forEach((item) => {
    ch += '<li>' + res['count'][item] + ': <tt class="click" onclick="show_pagename_name(\'' + item + '\')">' + item + '</tt></li>';
  })
  document.getElementById('searchres').innerHTML = ch;
}
function show_page_page(res) {
  let ch = '';
  Object.keys(res['count']).sort().reverse().forEach((item) => {
    ch += '<li><span class="click" onclick="show_pageday_date(\'' + item + '\')">' + item + '</span>: ' + res['count'][item] + '</li>';
  })
  document.getElementById('searchres').innerHTML = ch;
}
function show_pageday_date(date) {
  get_data('site=' + document.getElementById('target_site').value + '&target=page&date=' + date, show_page_date);
  document.getElementById('cond_pageday').checked = true;
  document.getElementById('cond_pageday_date').value = date;
}
function show_pagename_name(name) {
  get_data('site=' + document.getElementById('target_site').value + '&target=page&page=' + name, show_page_page);
  document.getElementById('cond_pagename').checked = true;
  document.getElementById('cond_pagename_name').value = name;
}
function show_ref(res) {
  let ch = '';
  Object.keys(res['count']).sort((a,b) => {return res['count'][b] - res['count'][a]; }).forEach((item) => {
    ch += '<li>' + res['count'][item] + ': <tt>' + item + '</tt></li>';
  })
  document.getElementById('searchres').innerHTML = ch;
}
function exec_query() {
  let sel = document.getElementById('target_set').elements['condition'].value;
  let site = document.getElementById('target_site').value;
  if (sel == 'pageday') { get_data('site=' + site + '&target=page&dst=' + document.getElementById('cond_pageday_date_st').value + '&ded=' + document.getElementById('cond_pageday_date_ed').value, show_page_date); }
  else if (sel == 'pagename') { get_data('site=' + site + '&target=page&page=' + document.getElementById('cond_pagename_name').value, show_page_page); }
  else if (sel == 'refday') { get_data('site=' + site + '&target=ref&dst=' + document.getElementById('cond_refday_date_st').value + '&ded=' + document.getElementById('cond_refday_date_ed').value, show_ref); }
  else if (sel == 'refpday') { get_data('site=' + site + '&target=ref&dst=' + document.getElementById('cond_refpday_date_st').value + '&ded=' + document.getElementById('cond_refpday_date_ed').value + '&page=' + document.getElementById('cond_refpday_page').value, show_ref); }
  else if (sel == 'refpage') { get_data('site=' + site + '&target=ref&page=' + document.getElementById('cond_refpage_page').value, show_ref); }
  else if (sel == 'uaday') { }
  else if (sel == 'uapday') { }
}
window.addEventListener('load', () => {
  document.getElementById('cond_exec').addEventListener('click', exec_query);
  document.getElementById('cond_pageday_dst').addEventListener('change', () => { document.getElementById('cond_pageday').checked = true; });
  document.getElementById('cond_pageday_ded').addEventListener('change', () => { document.getElementById('cond_pageday').checked = true; });
  document.getElementById('cond_pagename_name').addEventListener('change', () => { document.getElementById('cond_pagename').checked = true; });
  document.getElementById('cond_refday_dst').addEventListener('change', () => { document.getElementById('cond_refday').checked = true; });
  document.getElementById('cond_refday_ded').addEventListener('change', () => { document.getElementById('cond_refday').checked = true; });
  document.getElementById('cond_refpday_dst').addEventListener('change', () => { document.getElementById('cond_refpday').checked = true; });
  document.getElementById('cond_refpday_ded').addEventListener('change', () => { document.getElementById('cond_refpday').checked = true; });
  document.getElementById('cond_refpday_page').addEventListener('change', () => { document.getElementById('cond_refpday').checked = true; });
  document.getElementById('cond_refpage_page').addEventListener('change', () => { document.getElementById('cond_refpage').checked = true; });
  fetch(api_site)
  .then((res) => {
    if (res.ok) { return res.json(); }
    else { throw Error('failed to fetch site list'); }
  }).then((res) => {
    site_tz = res['log_tz'];
    document.getElementById('logtz').innerText = site_tz;
    site_list = res['sites'].sort();
    let elem = document.getElementById('target_site');
    site_list.forEach((item) => {
      let ch = '<option value="' + item + '">' + item + '</option>';
      elem.innerHTML += ch;
    });
  }).catch((e) => {
    // anything?
  })
})
-->
  </script>
</head>
<body>
<div id="showlog">
<h1>ウェブサーバログ解析結果表示</h1>
<p>
  このページでは、このサーバに載っているウェブサーバのアクセス解析を提供しています。
  以下の日付選択は<tt><span id="logtz"></span></tt>での0時から24時までのアクセス数を表示します。
  <br>
  サイトごとのアクセス制限は未実装です。
  <br>
  動的解析は未実装です。
</p>
<h2>パラメータ設定</h2>
<div>
  <form id="target_set">
  <label for="target_site">ターゲットサイト:</label>
  <select id="target_site"></select>
  <fieldset>
    <legend>詳細検索設定</legend>
    <ul>
      <li>アクセス数<ul>
        <li>
          <input type="radio" name="condition" id="cond_pageday" value="pageday"><label for="cond_pageday">期間指定でのページアクセス数リスト</label>:
          <input type="text" id="cond_pageday_date_st" placeholder="YYYY-MM-DD" inputmode="decimal"> ～
          <input type="text" id="cond_pageday_date_ed" placeholder="YYYY-MM-DD" inputmode="decimal"> ("年-月-日"の形式です)
        </li>
        <li>
          <input type="radio" name="condition" id="cond_pagename" value="pagename"><label for="cond_pagename">ページ名指定での日別アクセス数リスト</label>:
          <input type="text" id="cond_pagename_name" placeholder="/" size="50"> (日付指定での検索結果のページ一覧からも選択可能です)
        </li>
      </ul></li>
      <li>リンク元リスト<ul>
        <li>
          <input type="radio" name="condition" id="cond_refday" value="refday"><label for="cond_refday">期間指定でのリンク元リスト</label>:
          <input type="text" id="cond_refday_date_st" placeholder="YYYY-MM-DD" inputmode="decimal"> ～
          <input type="text" id="cond_refday_date_ed" placeholder="YYYY-MM-DD" inputmode="decimal"> ("年-月-日"の形式です)
        </li>
        <li>
          <input type="radio" name="condition" id="cond_refpday" value="refpday"><label for="cond_refpday">期間とページ名指定でのリンク元リスト</label>:
          期間: <input type="text" id="cond_refpday_date_st" placeholder="YYYY-MM-DD" inputmode="decimal"> ～
          <input type="text" id="cond_refpday_date_ed" placeholder="YYYY-MM-DD" inputmode="decimal"> ("年-月-日"の形式です)
          / ページ: <input type="text" id="cond_refpday_page" placeholder="/" size="50">
        </li>
        <li>
          <input type="radio" name="condition" id="cond_refpage" value="refpage"><label for="cond_refpage">ページ名指定でのリンク元リスト</label>:
          <input type="text" id="cond_refpage_page" placeholder="/" size="50"> (注: ログがある全期間の集計が表示されます)
        </li>
      </ul></li>
      <li>ブラウザリスト<ul>
        <li>
          <input type="radio" name="condition" id="cond_uaday" value="uaday" disabled><label for="cond_uaday">日付ごとのアクセスに利用されたブラウザリスト</label>
        </li>
        <li>
          <input type="radio" name="condition" id="cond_uapday" value="uapday" disabled><label for="cond_uapday">日付とページ名指定でのアクセスに利用されたブラウザリスト</label>
        </li>
      </ul></li>
    </ul>
  </fieldset>
  <input type="button" value="表示" id="cond_exec">
  </form>
</div>
<h2>検索結果</h2>
<ul>
  <li>ターゲットサイト: <span id="sres_site"></span></li>
  <li>検索条件: <span id="sres_cond"></span></li>
</ul>
<h3>結果リスト</h3>
<p>
  表示ボタンを押しても以下に何も表示されないもしくは更新されない場合は検索設定に誤りがある可能性があります。<br>
  結果表示内の下線付き部分をクリックした場合、日付については日付指定でのページアクセス数リスト、ページ名についてはページ名指定での日別アクセス数リストに遷移します。
</p>
<ul id="searchres"></ul>
</body>
</htad>